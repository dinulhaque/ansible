---
- vars_prompt:
    - name: "esxi_hostname"
      prompt: "Which ESX Host"
      private: no
    - name: "ip_address"
      prompt: "IP of vMotion vmkernal Port"
      private: no
  hosts: setup
  become: true
  become_user: root
  gather_facts: false
  tasks:
  - name: Configure DNS and Hostname
    vmware_dns_config:
      hostname: "{{ esxi_hostname }}"
      username: "{{ esxi_username }}"
      password: "{{ esxi_password }}"
      change_hostname_to: "{{ esxi_hostname }}"
      domainname: "{{ domainname }}"
      dns_servers:
          - "{{ dns_server1 }}"
          - "{{ dns_server2 }}"
      validate_certs: False
    delegate_to: localhost
  - name: Add vMotion Switch
    vmware_vswitch:
      hostname: "{{ esxi_hostname }}"
      username: "{{ esxi_username }}"
      password: "{{ esxi_password }}"
      esxi_hostname: "{{ esxi_hostname }}"
      switch: "{{ vswitch1 }}"
      nics:
        - "{{ vmnic_1 }}"
        - "{{ vmnic_4 }}"
      mtu: 1500
      validate_certs: False
      state: present
    delegate_to: localhost
  - name: Add Production Switch
    vmware_vswitch:
      hostname: "{{ esxi_hostname }}"
      username: "{{ esxi_username }}"
      password: "{{ esxi_password }}"
      esxi_hostname: "{{ esxi_hostname }}"
      switch: "{{ vswitch2 }}"
      nics:
        - "{{ vmnic_2 }}"
        - "{{ vmnic_5 }}"
      mtu: 1500
      validate_certs: False
      state: present
    delegate_to: localhost
  - name: Add to Management Switch
    vmware_vswitch:
      hostname: "{{ esxi_hostname }}"
      username: "{{ esxi_username }}"
      password: "{{ esxi_password }}"
      esxi_hostname: "{{ esxi_hostname }}"
      switch: "{{ vswitch0 }}"
      nics:
        - "{{ vmnic_3 }}"
      mtu: 1500
      validate_certs: False
      state: present
    delegate_to: localhost
  - name: Add vMotion Portgroup
    vmware_portgroup:
      hostname: "{{ esxi_hostname }}"
      username: "{{ esxi_username }}"
      password: "{{ esxi_password }}"
      hosts: "{{ esxi_hostname }}"
      switch: "{{ vswitch1 }}"
      portgroup: "{{ portgroup_name_vm }}"
      vlan_id: "{{ vlan_id_vm }}"
      state: present
      validate_certs: False
    delegate_to: localhost
  - name: Add Management Network VM Portgroup
    vmware_portgroup:
      hostname: "{{ esxi_hostname }}"
      username: "{{ esxi_username }}"
      password: "{{ esxi_password }}"
      hosts: "{{ esxi_hostname }}"
      switch: "{{ vswitch2 }}"
      portgroup: "{{ portgroup_name_pr }}"
      vlan_id: "{{ vlan_id_pr }}"
      state: present
      validate_certs: False
    delegate_to: localhost
  - name: Add vMotion vmkernel port with vMotion TCP/IP stack
    vmware_vmkernel:
      hostname: '{{ esxi_hostname }}'
      username: '{{ esxi_username }}'
      password: '{{ esxi_password }}'
      esxi_hostname: '{{ esxi_hostname }}'
      vswitch_name: "{{ vswitch1 }}"
      portgroup_name: "{{ portgroup_name_vm }}"
      network:
        type: 'static'
        ip_address: "{{ ip_address }}"
        subnet_mask: 255.255.255.0
        tcpip_stack: vmotion
      state: present
      validate_certs: False
    delegate_to: localhost
